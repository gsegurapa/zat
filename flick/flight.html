<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Flightstats Active Flight Picker</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.js"></script>
<style>
	body {
	  font-family: Tahoma, Geneva, sans-serif;
	  font-size: 1em;
	}
</style>
</head>
<body>
<div id="top">
Departing airport:
<input id="aircode" type="text" size="4" value="PDX" />
<input id="lookup" type="button" value="Lookup" />
</div>
<div id="out">
<table id="flights">
</table>
</div>
<script type="text/javascript">
(function($){
	var airportCode = 'PDX',	// default
			appId = '9543a3e8',
			appKey = '91d511451d9dbf38ede3efafefac5f09';

	$('#aircode').select();

	$('#lookup').on('click', lookup);
	$('#aircode').on('keydown', lookup);

	var debug,	// interactive debug
			zoomControl,	// show zoom control
			autoHide;	// auto hide controls

	function getParams(p) {
    var params = {}; // parameters
    p.replace(/[?&;]\s?([^=&;]+)=([^&;]*)/gi,
        function(m,key,value) { params[key] = value; });

    if (params.debug) { debug = params.debug === 'true'; }
    if (params.autoHide) { autoHide = params.autoHide === 'true'; }
    if (params.zoomControl) { zoomControl = params.zoomControl === 'true'; }
	}

	getParams(window.location.href); // read parameters from URL
	var extras = (debug ? '&debug='+debug : '') + (autoHide ? '&autoHide='+autoHide : '') + (zoomControl ? '&zoomControl='+zoomControl : '');

	function getAppendix(data) { // read in data from appendix and convert to dictionary
    ret = {};
    if (data) {
      for (var i = 0; i<data.length; i++) {
        var v = data[i];
        ret[v.fs] = v;
      }
    }
    return ret;
  }

	function lookup(e) {
		if (e.type === 'keydown' && e.keyCode !== 13) { return; }
		airportCode = $('#aircode').val().toUpperCase();
		var now = new Date();
		$.ajax({  // airport tracks departures
			url: 'https://api.flightstats.com/flex/flightstatus/rest/v2/jsonp/airport/status/' + airportCode + '/dep/' +
					now.getFullYear() + '/' + (1+now.getMonth()) + '/' + now.getDate() + '/' + now.getHours(),
      // url: 'https://api.flightstats.com/flex/flightstatus/rest/v2/jsonp/airport/tracks/' + airportCode + '/dep',
      data: { appId: appId, appKey: appKey },
      dataType: 'jsonp',
      success: getDepartures
    });
	}

	function getDepartures(data, status, xhr) {
		var $flights = $('#flights');
		$flights.empty();
		if (!data || data.error) {
			$flights.text('AJAX error: '+data.error.errorMessage)
			return;
		}
		if (debug) { console.log('departing flights: ',data); }
		var airlines = getAppendix(data.appendix.airlines);
		var airports = getAppendix(data.appendix.airports);
		var deps = [];
		$.each(data.flightStatuses, function(index, val) {
			deps.push({
					id: val.flightId,
					airlineCode: val.carrierFsCode,
					airline: airlines[val.carrierFsCode].name,
					flight: val.flightNumber,
					to: val.arrivalAirportFsCode,
					city: airports[val.arrivalAirportFsCode].city+(airports[val.arrivalAirportFsCode].countryCode==='US'?'':
							', '+airports[val.arrivalAirportFsCode].countryCode),
					leaves: val.departureDate.dateLocal.slice(0,16),
					codeshares: (val.codeshares ? val.codeshares : [])
				});
		});
		function comp(a, b) {
			return a.leaves > b.leaves ? -1 : 1;
		}
		deps.sort(comp);

		$flights.append('<tr><td>ID</td><td>LEAVES</td><td>TO</td><td>FLIGHT</td><td>CODESHARES</td></tr>');
		$.each(deps, function(index, val) {
			var fl = '<tr><td>'+val.id+'</td><td>'+val.leaves+'</td><td>'+val.to+' - '+val.city+
				'</td><td><a href="index.html?id='+val.id+'&airline='+val.airlineCode+'&flight='+val.flight+extras+'" title="'+val.airline+'">'+
				val.airlineCode+' '+val.flight+'</a></td><td>';
			$.each(val.codeshares, function(i, v) {
				if (v.relationship === 'S') { console.log('code S'); }
				fl = fl+v.relationship+': <a href="index.html?id='+val.id+'&airline='+v.fsCode+'&flight='+v.flightNumber+extras+'" title="'+
						airlines[v.fsCode].name+'">'+v.fsCode+' '+v.flightNumber+'</a> ';
				});
			$flights.append(fl+'</td></tr>');
		});
	}
}(jQuery));
</script>
</body>
</html>
