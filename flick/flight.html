<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Flightstats Active Flight Picker</title>
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.js"></script>
<style>
	body {
	  font-family: Tahoma, Geneva, sans-serif;
	  font-size: 1em;
	}
</style>
</head>
<body>
<div id="top">
Departing airport:
<input id="aircode" type="text" size="4" value="PDX" />
<input id="lookup" type="button" value="Lookup" />
</div>
<div id="out">
<table id="flights">
</table>
</div>
<script type="text/javascript">
(function($){
	var airportCode = 'PDX',	// default
			appId = '9543a3e8',
			appKey = '91d511451d9dbf38ede3efafefac5f09';

	$('#aircode').select();

	$('#lookup').on('click', lookup);
	$('#aircode').on('keydown', lookup);

	var debug,	// interactive debug
			zoom,	// show zoom control
			hide;	// auto hide controls

	function getParams(p) {
    var params = {}; // parameters
    p.replace(/[?&;]\s?([^=&;]+)=([^&;]*)/gi,
        function(m,key,value) { params[key] = value; });

    if (params.debug) { debug = params.debug === 'true'; }
    if (params.hide) { hide = params.hide === 'true'; }
    if (params.zoom) { zoom = params.zoom === 'true'; }
	}

	getParams(window.location.href); // read parameters from URL
	var extras = (debug ? '&debug='+debug : '') + (hide ? '&hide='+hide : '') + (zoom ? '&zoom='+zoom : '');

	function getAppendix(data) { // read in data from appendix and convert to dictionary
    ret = {};
    if (data) {
      for (var i = 0; i<data.length; i++) {
        var v = data[i];
        ret[v.fs] = v;
      }
    }
    return ret;
  }

	function lookup(e) {
		if (e.type === 'keydown' && e.keyCode !== 13) { return; }
		airportCode = $('#aircode').val().toUpperCase();
		$.ajax({  // airport tracks departures
      url: 'https://api.flightstats.com/flex/flightstatus/rest/v2/jsonp/airport/tracks/' + airportCode + '/dep',
      data: { appId: appId, appKey: appKey, maxPositions: 2 },
      dataType: 'jsonp',
      success: getDepartures
    });
	}

	function getDepartures(data, status, xhr) {
		var $flights = $('#flights');
		$flights.empty();
		if (!data || data.error) {
			$flights.text('AJAX error: '+data.error.errorMessage)
			return;
		}
		if (debug) { console.log('departing flights: ',data); }
		var airlines = getAppendix(data.appendix.airlines);
		var airports = getAppendix(data.appendix.airports);
		var deps = [];
		$.each(data.flightTracks, function(index, val) {
			deps.push({id: val.flightId,
								airlineCode: val.carrierFsCode,
								airline: airlines[val.carrierFsCode].name,
								flight: val.flightNumber,
								to: val.arrivalAirportFsCode,
								city: airports[val.arrivalAirportFsCode].city+(airports[val.arrivalAirportFsCode].countryCode==='US'?'':', '+airports[val.arrivalAirportFsCode].countryCode),
								leaves: val.departureDate.dateLocal.slice(0,16)});
		});
		function comp(a, b) {
			return a.leaves > b.leaves ? -1 : 1;
		}
		deps.sort(comp);

		$flights.append('<tr><td>ID</td><td>FLIGHT</td><td>TO</td><td>LEAVES</td></tr>');
		$.each(deps, function(index, val) {
			$flights.append('<tr><td><a href="index.html?id='+val.id+
				'&airline='+val.airlineCode+'&flight='+val.flight+extras+'">'+val.id+'</a></td><td>'+
				val.airline+' '+val.flight+'</td><td>'+val.to+' - '+val.city+
				'</td><td>'+val.leaves+'</td></tr>');
				// '</td><td><a href="http://www.flightstats.com/go/InternalAPI/singleFlightTracker.do?id='+
				// val.flightId+'&airlineCode='+val.carrierFsCode+'&flightNumber='+val.flightNumber+
				// '&version=1.0&key=49e3481552e7c4c9%253A-5b147615%253A12ee3ed13b5%253A-5f90&responseType=jsonp" target="_blank">chris data</a></td></tr>');
		});
	}
}(jQuery));
</script>
</body>
</html>
